#!/usr/bin/env ruby
# Get the Gtk2App library
require 'rubygems'
gem 'gtk2applib', '~> 9.2'
require 'gtk2applib'
include Gtk2AppLib

# Miscellaneous info on this application/file
Lock.lock_mode
program = Program.new( {
	:name		=> 'Ruby-Gnome Alerts',
	:authors	=> ['carlosjhr64@gmail.com'],
	:website	=> 'http://ruby-gnome-apps.blogspot.com/search/label/Alerts',
	:website_label	=> 'Ruby-Gnome Alerts',
	:license	=> 'GPL',
	:copyright	=> '2010-09-16 17:17:19',
	} )

# Open a pipe to the alerts daemon
IO.popen('gtk2alertdaemon','w+') {|pipe|
  pipe.puts "l #{Configuration::ALERTS_DATA_FILE}"
  pipe.flush

  begin
    require 'gtk2alertapp/alertparser.rb'
    require 'gtk2alertapp.rb'

    program.window do |window|
      # Ask daemon for a listing of current alerts
      alerts = Gtk2AlertApp::Alerts.new
      pipe.puts 'l'
      pipe.flush
      while (line = pipe.gets.strip).length > 0 do
        begin
          alerts.add(line)
        rescue Exception
          $!.puts_bang!(line) # since the daemon uses the same parser, this should not happen
        end
      end

      # Build the alerts editor
      vbox = Widgets::VBox.new( Widgets::ScrolledWindow.new(window) )

      hbox = Widgets::HBox.new(vbox)
      Gtk2AlertApp::DigitalClock.new("%A, %B %d %Y, %I:%M:%S %p",hbox)
      alert_editor = Gtk2AlertApp::AlertEditor.new(pipe, vbox, alerts)

      # Show the alerts listings
      entry_rows = Gtk2AlertApp::EntryRows.new(pipe,alert_editor,alerts,vbox)
      alerts.keys.sort{|a,b| a.upcase<=>b.upcase}.each{|name|
        entry_rows.add(name)
      }
      # Give alert_editor a hook to entry_rows,
      # allows alert_editor to populate entry_rows
      alert_editor.entry_rows = entry_rows
    end
  rescue Exception
    $!.puts_bang!
  ensure
    program.finalize
  end
}

